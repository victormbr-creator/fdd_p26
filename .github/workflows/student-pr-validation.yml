name: Student PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-student-changes:
    name: Validate Student Directory
    runs-on: ubuntu-latest

    steps:
      - name: Check PR author permissions
        id: check-author
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          echo "PR Author: $PR_AUTHOR"
          echo "Repo Owner: $REPO_OWNER"

          # Bypass check for owner or uumami
          if [[ "$PR_AUTHOR" == "uumami" || "$PR_AUTHOR" == "$REPO_OWNER" ]]; then
            echo "bypass=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Usuario autorizado: $PR_AUTHOR - sin restricciones"
          else
            echo "bypass=false" >> $GITHUB_OUTPUT
            echo "üë§ Estudiante: $PR_AUTHOR - validando cambios..."
          fi

      - name: Checkout repository
        if: steps.check-author.outputs.bypass != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate changed files
        if: steps.check-author.outputs.bypass != 'true'
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=============================================="
          echo "  VALIDACION DE PULL REQUEST - ESTUDIANTES"
          echo "=============================================="
          echo ""
          echo "üë§ Usuario: $PR_AUTHOR"
          echo "üìÅ Directorio permitido: estudiantes/$PR_AUTHOR/"
          echo ""

          # Get list of changed files
          CHANGED_FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only)

          echo "üìã Archivos modificados en este PR:"
          echo "$CHANGED_FILES"
          echo ""

          # Define forbidden files/patterns (OS and IDE junk)
          # These are NEVER allowed, even in student's own directory
          is_forbidden_file() {
            local file="$1"
            local basename=$(basename "$file")
            
            # macOS files
            [[ "$basename" == ".DS_Store" ]] && return 0
            [[ "$basename" == "._.DS_Store" ]] && return 0
            [[ "$basename" == "._"* ]] && return 0  # macOS resource forks
            [[ "$basename" == ".AppleDouble" ]] && return 0
            [[ "$basename" == ".LSOverride" ]] && return 0
            [[ "$basename" == ".Spotlight-V100" ]] && return 0
            [[ "$basename" == ".Trashes" ]] && return 0
            
            # Windows files
            [[ "$basename" == "Thumbs.db" ]] && return 0
            [[ "$basename" == "Thumbs.db:encryptable" ]] && return 0
            [[ "$basename" == "ehthumbs.db" ]] && return 0
            [[ "$basename" == "Desktop.ini" ]] && return 0
            
            # IDE/Editor directories and files
            [[ "$file" == *"/.idea/"* ]] && return 0
            [[ "$file" == *"/.vscode/"* ]] && return 0
            [[ "$file" == *"/.vs/"* ]] && return 0
            [[ "$basename" == "*.swp" ]] && return 0
            [[ "$basename" == "*.swo" ]] && return 0
            [[ "$basename" == "*~" ]] && return 0
            
            # Python cache
            [[ "$file" == *"/__pycache__/"* ]] && return 0
            [[ "$basename" == "*.pyc" ]] && return 0
            [[ "$basename" == "*.pyo" ]] && return 0
            [[ "$file" == *"/.ipynb_checkpoints/"* ]] && return 0
            
            # Node
            [[ "$file" == *"/node_modules/"* ]] && return 0
            
            # Environment files (security)
            [[ "$basename" == ".env" ]] && return 0
            [[ "$basename" == ".env.local" ]] && return 0
            [[ "$basename" == ".env."* ]] && return 0
            
            return 1
          }

          # Check each file
          INVALID_FILES=""
          FORBIDDEN_FILES=""
          VALID_COUNT=0
          INVALID_COUNT=0
          FORBIDDEN_COUNT=0

          while IFS= read -r file; do
            if [[ -z "$file" ]]; then
              continue
            fi

            # First check if it's a forbidden file (never allowed anywhere)
            if is_forbidden_file "$file"; then
              echo "üö´ $file (archivo prohibido)"
              FORBIDDEN_FILES="$FORBIDDEN_FILES\n  - $file"
              FORBIDDEN_COUNT=$((FORBIDDEN_COUNT + 1))
              continue
            fi

            # Check if file is within allowed directory
            # Pattern: estudiantes/USERNAME/ or estudiantes/USERNAME/anything
            if [[ "$file" =~ ^estudiantes/"$PR_AUTHOR"(/.*)?$ ]]; then
              echo "‚úÖ $file"
              VALID_COUNT=$((VALID_COUNT + 1))
            else
              echo "‚ùå $file"
              INVALID_FILES="$INVALID_FILES\n  - $file"
              INVALID_COUNT=$((INVALID_COUNT + 1))
            fi
          done <<< "$CHANGED_FILES"

          echo ""
          echo "=============================================="

          # Handle forbidden files error
          if [[ $FORBIDDEN_COUNT -gt 0 ]]; then
            echo ""
            echo "üö´ ERROR: ARCHIVOS PROHIBIDOS DETECTADOS"
            echo ""
            echo "Los siguientes archivos NO deben estar en el repositorio:"
            echo -e "$FORBIDDEN_FILES"
            echo ""
            echo "Estos archivos son generados automaticamente por el sistema"
            echo "operativo o tu IDE y no deben ser commiteados."
            echo ""
            echo "Para eliminarlos de tu commit:"
            echo "  git rm --cached <archivo>"
            echo "  git commit --amend"
            echo ""
            echo "Agrega un archivo .gitignore con estos patrones para evitar"
            echo "commitearlos en el futuro."
            echo ""
          fi

          # Handle invalid location error
          if [[ $INVALID_COUNT -gt 0 ]]; then
            echo ""
            echo "‚ùå ERROR: CAMBIOS FUERA DE TU DIRECTORIO"
            echo ""
            echo "Solo puedes modificar archivos dentro de tu carpeta:"
            echo "  estudiantes/$PR_AUTHOR/"
            echo ""
            echo "Archivos en ubicaciones NO permitidas:"
            echo -e "$INVALID_FILES"
            echo ""
            echo "=============================================="
            echo "¬øQUE HACER?"
            echo "=============================================="
            echo "1. Elimina los archivos que no te pertenecen de tu commit"
            echo "2. Asegurate de trabajar SOLO en: estudiantes/$PR_AUTHOR/"
            echo "3. Usa: git checkout main -- <archivo> para deshacer cambios"
            echo "4. Haz push de los cambios corregidos"
            echo ""
          fi

          # Exit with error if any issues found
          if [[ $FORBIDDEN_COUNT -gt 0 || $INVALID_COUNT -gt 0 ]]; then
            exit 1
          fi

          echo ""
          echo "‚úÖ VALIDACION EXITOSA"
          echo ""
          echo "Todos los $VALID_COUNT archivo(s) estan en tu directorio permitido."
          echo ""
